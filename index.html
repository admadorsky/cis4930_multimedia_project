<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Story Insight: Script &amp; Screenplay Expert System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-6xl px-4 py-6">
      <h1 class="text-3xl font-semibold text-indigo-700">Story Insight: Script &amp; Screenplay Expert System</h1>
      <p class="mt-1 text-sm text-slate-500">Prototype interface for evaluating scripts with a future expert system.</p>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8 space-y-6">
    <section class="grid gap-6 lg:grid-cols-2">
      <!-- Input Column -->
      <section class="space-y-6">
        <div class="rounded-2xl bg-white p-6 shadow-sm">
          <header class="mb-4">
            <p class="text-xs uppercase tracking-wide text-indigo-500">Input</p>
            <h2 class="text-xl font-semibold text-slate-900">Script / Screenplay Text</h2>
          </header>
          <form id="scriptForm" class="space-y-4">
            <div>
              <label for="scriptText" class="sr-only">Script / Screenplay Text</label>
              <textarea id="scriptText" rows="12"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none"
                placeholder="Paste your screenplay or story text here..."></textarea>
              <p id="textWarning" class="mt-2 hidden text-sm text-red-500">Please paste a script before analyzing.</p>
              <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
                <span id="charCount">0 characters</span>
                <span id="wordCount">0 words</span>
              </div>
            </div>
            <button id="analyzeBtn" type="submit"
              class="inline-flex w-full items-center justify-center rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2">
              Analyze Story
            </button>
          </form>
          <p id="analysisStatus" class="mt-3 text-sm text-slate-500"></p>
        </div>

        <div class="rounded-2xl bg-white p-6 shadow-sm">
          <header class="mb-4">
            <p class="text-xs uppercase tracking-wide text-indigo-500">Story Metadata (Optional)</p>
            <h2 class="text-xl font-semibold text-slate-900">Context &amp; Details</h2>
          </header>
          <div class="grid gap-4">
            <div>
              <label for="genre" class="mb-1 block text-sm font-medium text-slate-700">Genre</label>
              <select id="genre"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none">
                <option value="N/A">N/A</option>
                <option value="Drama">Drama</option>
                <option value="Comedy">Comedy</option>
                <option value="Thriller">Thriller</option>
                <option value="Sci-Fi">Sci-Fi</option>
                <option value="Fantasy">Fantasy</option>
              </select>
            </div>
            <div>
              <label for="length" class="mb-1 block text-sm font-medium text-slate-700">Length</label>
              <select id="length"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none">
                <option value="N/A">N/A</option>
                <option value="Short Film">Short Film</option>
                <option value="Feature">Feature</option>
                <option value="Pilot">Pilot</option>
                <option value="Episode">Episode</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="mood" class="mb-1 block text-sm font-medium text-slate-700">Mood / Tone</label>
              <select id="mood"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none">
                <option value="N/A">N/A</option>
                <option value="Reflective">Reflective</option>
                <option value="Coming-of-age">Coming-of-age</option>
                <option value="Introspective">Introspective</option>
                <option value="Hopeful">Hopeful</option>
                <option value="Somber">Somber</option>
                <option value="Tense">Tense</option>
              </select>
            </div>
            <div>
              <label for="audience" class="mb-1 block text-sm font-medium text-slate-700">Target Audience</label>
              <select id="audience"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none">
                <option>N/A</option>
                <option>Kids</option>
                <option>YA</option>
                <option>Adult</option>
                <option>General</option>
              </select>
            </div>
            <div>
              <label for="setting" class="mb-1 block text-sm font-medium text-slate-700">Setting</label>
              <select id="setting"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-indigo-400 focus:bg-white focus:outline-none">
                <option value="N/A">N/A</option>
                <option value="Wilderness">Wilderness</option>
                <option value="Coastal">Coastal</option>
                <option value="Outer Space">Outer Space</option>
                <option value="Urban">Urban</option>
                <option value="Arid">Arid / Desert</option>
                <option value="Mountainous">Mountainous</option>
                <option value="Stormy">Stormy / Rain-soaked</option>
                <option value="War-torn">War-torn / Conflict Zone</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Analysis Column -->
      <section class="space-y-6">
        <div class="rounded-2xl bg-white p-6 shadow-sm">
          <header class="mb-4">
            <p class="text-xs uppercase tracking-wide text-indigo-500">Analysis Results</p>
            <h2 class="text-xl font-semibold text-slate-900">Overall Story Snapshot</h2>
          </header>
          <div class="rounded-2xl border border-indigo-100 bg-indigo-50/80 p-4 text-indigo-900">
            <p class="text-4xl font-bold" id="overallScore">—</p>
            <p class="mt-1 text-sm text-indigo-700">Average score across expert categories.</p>
            <p class="mt-3 text-sm" id="overallSummary">
              This is placeholder overall feedback. In the future, an expert system will summarize key strengths and
              opportunities based on your story’s emotional impact, character depth, and narrative resolution.
            </p>
          </div>
        </div>

        <div class="rounded-2xl bg-white p-6 shadow-sm">
          <header class="mb-4">
            <p class="text-xs uppercase tracking-wide text-indigo-500">Story Feedback Overview</p>
            <h2 class="text-xl font-semibold text-slate-900">Category Scores</h2>
          </header>
          <div id="scoresGrid" class="grid gap-4 sm:grid-cols-2">
            <!-- Score cards injected here -->
          </div>
        </div>

        <div class="rounded-2xl bg-white p-6 shadow-sm">
          <header class="mb-4">
            <p class="text-xs uppercase tracking-wide text-indigo-500">Expert Rules Details</p>
            <h2 class="text-xl font-semibold text-slate-900">Rule Insights</h2>
          </header>
          <ul id="rulesList" class="space-y-3">
            <!-- Rules injected via JS -->
          </ul>
        </div>
      </section>
    </section>
  </main>

  <script>
    const API_URL = 'http://127.0.0.1:5000/analyze';

    const scriptText = document.getElementById('scriptText');
    const charCount = document.getElementById('charCount');
    const wordCount = document.getElementById('wordCount');
    const form = document.getElementById('scriptForm');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const textWarning = document.getElementById('textWarning');
    const analysisStatus = document.getElementById('analysisStatus');
    const scoresGrid = document.getElementById('scoresGrid');
    const overallScoreEl = document.getElementById('overallScore');
    const overallSummaryEl = document.getElementById('overallSummary');
    const rulesList = document.getElementById('rulesList');
    const genreField = document.getElementById('genre');
    const lengthField = document.getElementById('length');
    const moodField = document.getElementById('mood');
    const audienceField = document.getElementById('audience');
    const settingField = document.getElementById('setting');

    const CATEGORY_SPECS = [
      { id: 'emotion', label: 'Emotion' },
      { id: 'character-depth', label: 'Character Depth' },
      { id: 'human-experience', label: 'Human Experience' },
      { id: 'symbolism', label: 'Symbolism & Motifs' },
      { id: 'conflict', label: 'Conflict & Resolution' },
      { id: 'sensory', label: 'Sensory Immersion' },
      { id: 'authenticity', label: 'Authenticity / Originality' },
      { id: 'rhythm', label: 'Dynamic Rhythm / Pacing' },
      { id: 'audience-fit', label: 'Audience Fit' },
      { id: 'moral', label: 'Moral Resonance / Thematic Impact' }
    ];

    const rules = [
      {
        title: 'Emotion First Rule',
        description: 'Every story must evoke at least one dominant emotion (joy, fear, hope, or sorrow) and maintain emotional continuity throughout the narrative.'
      },
      {
        title: 'Character Depth Rule',
        description: 'Characters should possess goals, flaws, and growth arcs that evolve naturally through conflict and consequence.'
      },
      {
        title: 'Human Experience Rule',
        description: 'Ground every story in universal human experiences (love, loss, ambition, and identity) so that even the most fantastical tales feel relatable.'
      },
      {
        title: 'Symbolism Rule',
        description: 'Use recurring symbols, metaphors, or motifs to give deeper meaning to surface events and connect abstract ideas to emotional truth.'
      },
      {
        title: 'Contextual Adaptation Rule',
        description: 'Adjust tone, pacing, and language style based on the intended audience.'
      },
      {
        title: 'Conflict & Resolution Rule',
        description: 'Every narrative must contain tension that challenges the protagonist and culminates in a meaningful resolution.'
      },
      {
        title: 'Sensory Immersion Rule',
        description: 'Invoke vivid sensory details to create immersive worlds that draw the audience into the story’s atmosphere.'
      },
      {
        title: 'Authenticity Rule',
        description: 'Avoid clichés and predictable plotlines; instead, derive originality from genuine emotion, character motivation, and unique perspectives.'
      },
      {
        title: 'Dynamic Rhythm Rule',
        description: "Balance moments of action and reflection, dialogue and silence, so the story 'breathes' and mirrors the rhythm of real life."
      },
      {
        title: 'Moral Resonance Rule',
        description: 'End each story with an insight, question, or moral tension that lingers—something that encourages reflection beyond the final scene.'
      }
    ];

    const updateCounts = () => {
      const text = scriptText.value;
      charCount.textContent = `${text.length} characters`;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      wordCount.textContent = `${words} words`;
    };

    const normalizeMetadataValue = (value) => {
      if (typeof value !== 'string') return null;
      const cleaned = value.trim();
      if (!cleaned || cleaned === 'N/A') {
        return null;
      }
      return cleaned;
    };

    const collectMetadata = () => ({
      genre: normalizeMetadataValue(genreField.value),
      length: normalizeMetadataValue(lengthField.value),
      mood: normalizeMetadataValue(moodField.value),
      audience: normalizeMetadataValue(audienceField.value),
      setting: normalizeMetadataValue(settingField.value)
    });

    const renderRules = (breakdown = null) => {
      rulesList.innerHTML = rules.map(rule => {
        const result = breakdown?.[rule.title];
        const scoreText = result ? `${result.score} / ${result.max_points}` : 'Pending';
        const badgeStyle = result ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-200 text-slate-600';
        return `
        <li class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-sm font-semibold text-slate-900">${rule.title}</p>
              <p class="mt-1 text-sm text-slate-600">${rule.description}</p>
            </div>
            <span class="rounded-full px-3 py-1 text-xs font-semibold ${badgeStyle}">
              ${scoreText}
            </span>
          </div>
        </li>`;
      }).join('');
    };

    const renderScores = (scores) => {
      scoresGrid.innerHTML = scores.map(({ category, raw_score, max_points, message }) => {
        const scoreDisplay = typeof raw_score === 'number' ? raw_score.toFixed(1).replace(/\.0$/, '') : raw_score;
        const maxDisplay = typeof max_points === 'number' ? max_points : '—';
        return `
        <article class="flex flex-col rounded-2xl border border-slate-200 p-4 shadow-sm">
          <p class="text-sm font-semibold text-slate-900">${category}</p>
          <p class="mt-2 text-3xl font-bold text-indigo-600">${scoreDisplay} / ${maxDisplay}</p>
          <p class="mt-1 text-xs text-slate-500">Rule points</p>
          <p class="mt-2 text-sm text-slate-600">${message ?? `Feedback on ${category} will appear here.`}</p>
        </article>
        `;
      }).join('');
    };

    const renderScoresFromResult = (categories = []) => {
      renderScores(categories.map(item => ({
        category: item.category,
        message: item.message,
        raw_score: item.raw_score,
        max_points: item.max_points
      })));
    };

    const buildSummary = (categories = []) => {
      if (!categories.length) {
        return 'Provide a script to see detailed strengths, pacing, and thematic insights.';
      }

      const sorted = [...categories].sort((a, b) => b.score - a.score);
      const strengths = sorted.slice(0, 2).map(item => item.category).join(' & ');
      const lowest = sorted[sorted.length - 1];
      const lowestReview = typeof lowest.message === 'string'
        ? lowest.message.toLowerCase()
        : 'needs additional development';
      return `Strengths: ${strengths}. Opportunity: deepen ${lowest.category.toLowerCase()} (${lowestReview}).`;
    };

    const toggleAnalyzingState = (isAnalyzing) => {
      analyzeBtn.disabled = isAnalyzing;
      analyzeBtn.classList.toggle('opacity-70', isAnalyzing);
    };

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const text = scriptText.value.trim();

      if (!text) {
        textWarning.classList.remove('hidden');
        analysisStatus.textContent = '';
        return;
      }

      textWarning.classList.add('hidden');
      analysisStatus.textContent = 'Analyzing…';
      toggleAnalyzingState(true);

      fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          text,
          metadata: collectMetadata()
        })
      })
        .then(async (response) => {
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.error || 'Analysis failed.');
          }
          return payload;
        })
        .then((data) => {
          renderScoresFromResult(data.categories);
          overallScoreEl.textContent = data.overall_score.toFixed(1);
          overallSummaryEl.textContent = buildSummary(data.categories);
          renderRules(data.breakdown);
          analysisStatus.textContent = 'Analysis complete. Scores refreshed.';
        })
        .catch((error) => {
          analysisStatus.textContent = error.message || 'Unable to analyze the story.';
        })
        .finally(() => {
          toggleAnalyzingState(false);
        });
    });

    scriptText.addEventListener('input', () => {
      updateCounts();
      if (scriptText.value.trim()) {
        textWarning.classList.add('hidden');
      }
    });

    // Initial render
    updateCounts();
    renderRules();
    renderScores(CATEGORY_SPECS.map(spec => ({
      category: spec.label,
      raw_score: '—',
      max_points: null,
      message: 'Awaiting analysis.'
    })));
  </script>
</body>

</html>